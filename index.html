<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Peni FMS Offload Tool</title>

<style>
:root{
  --bg:#0a0c10;--card:#0f1420;--text:#e6edf6;--muted:#93a4b7;
  --accent:#7c3aed;--accent2:#22d3ee;--ok:#10b981;--bad:#ef4444;--border:#1f2a3a
}
*{box-sizing:border-box}
html,body{
  margin:0;
  background:radial-gradient(1200px 900px at 10% -10%, #121a2b 0%, transparent 60%), var(--bg);
  color:var(--text);
  font-family:Inter,system-ui,Segoe UI,Roboto,Ubuntu,Arial,sans-serif
}
.wrap{max-width:980px;margin:40px auto;padding:0 16px 64px}
h1{margin:0 0 6px;font-size:26px}
.sub{color:var(--muted);margin-bottom:18px}
.card{
  background:linear-gradient(180deg, rgba(255,255,255,.02), transparent), var(--card);
  border:1px solid var(--border);
  border-radius:18px;
  padding:18px;
  box-shadow:0 10px 30px rgba(0,0,0,.35)
}
textarea{
  width:100%;
  min-height:200px;
  background:#0b0f19;
  border:1px solid var(--border);
  color:var(--text);
  border-radius:14px;
  padding:12px;
}
.row{display:flex;gap:10px;align-items:center}
.btn{cursor:pointer;border-radius:14px;padding:10px 16px;border:1px solid var(--border)}
.btn-primary{
  background:linear-gradient(90deg,var(--accent),var(--accent2));
  color:#05070b;font-weight:700
}
.btn-ghost{background:transparent;color:var(--text)}
.bar{height:10px;background:#0b0f19;border-radius:999px;border:1px solid var(--border);overflow:hidden}
.fill{height:100%;width:0;background:linear-gradient(90deg,var(--ok),var(--accent2))}
pre{
  background:#0b0f19;border-radius:14px;border:1px solid var(--border);
  padding:12px;white-space:pre-wrap
}
.muted{font-size:12px;color:var(--muted)}
</style>
</head>
<body>

<div class="wrap">
  <h1>Peni FMS Offload Tool</h1>
  <div class="sub">
    Paste PRO numbers and run Offload.  
    All orders are automatically offloaded to **HAY**.
  </div>

  <div class="card">
    <textarea id="input" placeholder="3034414 / 3039888 / 3034414 / 62102175"></textarea>
    <div class="muted" id="proMeta">0 PROs detected</div>

    <div class="row">
      <button class="btn btn-primary" id="run">Run Offload</button>
      <button class="btn btn-ghost" id="preview">Check Order Info</button>
      <button class="btn btn-ghost" id="export" disabled>Export Results (.txt)</button>
    </div>

    <div class="row muted" style="justify-content:space-between">
      <div id="status">Idle</div>
      <div id="eta">ETA —</div>
    </div>

    <div class="bar"><div class="fill" id="fill"></div></div>
    <div class="muted" id="counts">0/0</div>
  </div>

  <div class="card" style="margin-top:16px">
    <strong>Output</strong>
    <pre id="out"></pre>
  </div>
</div>

<script>
(() => {

const BASE="https://fms.item.com";
const FMS_CLIENT="FMS_WEB";
const COMPANY_ID="SBFH";

const USERNAME="PeniTaufalele";
const PASSWORD="FMSoffload1!";
const HARD_TERMINAL="HAY";

const LOGIN_URL=`${BASE}/fms-platform-user/Auth/Login`;
const SEARCH_URL=`${BASE}/fms-platform-order/shipment-orders/query`;
const OFFLOAD_URL=`${BASE}/fms-platform-order/status/shipment/set-offload`;

const ORDER_BASIC_URL=`${BASE}/fms-platform-order/shipper/getshipment-orderbasic/`;
const ORDER_HEAD_URL=`${BASE}/fms-platform-order/shipper/getshipment-orderbasic-headinfo/`;

const MAX_ORDERS=150, RETRIES=2;

const $=id=>document.getElementById(id);

let TOKEN=null;

const input=$("input");
const runBtn=$("run");
const prevBtn=$("preview");
const exportBtn=$("export");
const proMeta=$("proMeta");
const out=$("out");
const status=$("status");
const eta=$("eta");
const fill=$("fill");
const counts=$("counts");

function parsePros(t){
  return [...new Set((String(t).match(/\b\d{6,14}\b/g)||[]))];
}

async function auth(){
  if(TOKEN) return TOKEN;
  const r=await fetch(LOGIN_URL,{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "fms-client":FMS_CLIENT
    },
    body:JSON.stringify({account:USERNAME,password:PASSWORD})
  });
  const j=await r.json();
  TOKEN=j.token||j?.data?.token;
  if(!TOKEN) throw new Error("Login failed");
  return TOKEN;
}

async function searchOrders(token,pros){
  const r=await fetch(SEARCH_URL,{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "fms-client":FMS_CLIENT,
      "fms-token":token,
      "Company-Id":COMPANY_ID
    },
    body:JSON.stringify({
      tracking_nos:pros,
      page_number:1,
      page_size:pros.length,
      record_status:"0"
    })
  });
  return r.json();
}

function buildMap(data){
  const map={};
  (data?.data?.items||[]).forEach(i=>{
    if(i.tracking_no && i.order_no){
      map[i.tracking_no]=i.order_no;
    }
  });
  return map;
}

function reset(){
  out.textContent="";
  fill.style.width="0%";
  counts.textContent="0/0";
  eta.textContent="ETA —";
}

function line(t){
  out.textContent+=(out.textContent?"\n":"")+t;
}

async function runOffload(){
  reset();
  try{
    const pros=parsePros(input.value);
    if(!pros.length) return line("[Error] No PROs detected.");

    status.textContent="Authenticating…";
    const token=await auth();

    status.textContent="Searching…";
    const data=await searchOrders(token,pros.slice(0,MAX_ORDERS));
    const map=buildMap(data);

    const list=[];
    pros.forEach(p=>{
      map[p]?list.push([p,map[p]]):line(`${p} -> (no DO found) ---`);
    });

    const total=list.length;
    let done=0;

    status.textContent="Running Offload…";

    for(const [pro,DO] of list){
      const key=DO.replace(/\D/g,"");
      let ok=false;

      for(let a=0;a<=RETRIES;a++){
        const r=await fetch(OFFLOAD_URL,{
          method:"POST",
          headers:{
            "Content-Type":"application/json",
            "fms-client":FMS_CLIENT,
            "fms-token":token,
            "company-id":COMPANY_ID
          },
          body:JSON.stringify({
            order_status:"Override Offload",
            order_keys:[Number(key)],
            terminal:HARD_TERMINAL
          })
        });

        if(r.ok){ ok=true; break; }
      }

      if(ok){
        line(`${pro} | PU - -> ${DO} - offloaded @ HAY ---`);
      }else{
        line(`${pro} | PU - -> ${DO} | Offload failed ---`);
      }

      done++;
      fill.style.width=(done/total*100)+"%";
      counts.textContent=`${done}/${total}`;
    }

    status.textContent="Done";
    exportBtn.disabled=false;

  }catch(e){
    status.textContent="ERROR";
    line(`[ERROR] ${e.message}`);
  }
}

async function checkInfo(){
  reset();
  try{
    const pros=parsePros(input.value);
    if(!pros.length) return line("[Error] No PROs detected.");

    status.textContent="Authenticating…";
    const token=await auth();

    status.textContent="Searching…";
    const data=await searchOrders(token,pros.slice(0,MAX_ORDERS));
    const map=buildMap(data);

    for(const p of pros){
      const DO=map[p];
      if(!DO){
        line(`${p} -> (no DO found) ---`);
        continue;
      }

      let loc="—", statusTxt="—", sub="—", pu="-";

      const headers={
        "fms-client":FMS_CLIENT,
        "fms-token":token,
        "Company-Id":COMPANY_ID
      };

      try{
        const b=await fetch(ORDER_BASIC_URL+DO,{headers});
        const jb=await b.json();
        const d=jb?.data||jb;
        loc=d?.current_location||loc;
        pu=d?.reference5||pu;
      }catch{}

      try{
        const h=await fetch(ORDER_HEAD_URL+DO,{headers});
        const jh=await h.json();
        const d=jh?.data||jh;
        statusTxt=d?.order_status_describe||statusTxt;
        sub=d?.order_sub_status_describe||sub;
      }catch{}

      line(`${p} | PU ${pu} -> ${DO} | Loc: ${loc} | Status: ${statusTxt} | Substatus: ${sub} ---`);
    }

    status.textContent="Done";
    exportBtn.disabled=false;

  }catch(e){
    status.textContent="ERROR";
    line(`[ERROR] ${e.message}`);
  }
}

input.addEventListener("input",()=>{
  const p=parsePros(input.value);
  proMeta.textContent=`${p.length} PRO${p.length==1?"":"s"} detected`;
  runBtn.disabled=!p.length;
  prevBtn.disabled=!p.length;
});

runBtn.addEventListener("click", runOffload);
prevBtn.addEventListener("click", checkInfo);

exportBtn.addEventListener("click",()=>{
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([out.textContent]));
  a.download=`peni_fms_offload_${Date.now()}.txt`;
  a.click();
});

})();
</script>
</body>
</html>
